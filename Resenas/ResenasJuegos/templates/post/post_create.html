{% extends 'layouts/general_layout.html' %}


{% block content_layout %}
<div class="max-w-3xl mx-auto px-4 py-8">
  <h1 class="text-3xl font-bold mb-8 text-center text-[#f0f1f4]">
    Creación de Post
  </h1>

  <form method="post" enctype="multipart/form-data"
    class="space-y-6 bg-[#0B071A] p-6 rounded-xl border border-[#241D44]">
    {% csrf_token %}

    <!-- Campos principales -->
    <div class="space-y-6">
      <!-- Título -->
      <div class="form-group">
        <label class="block mb-2 text-[#f0f1f4] font-medium">Título</label>
        <input type="text" name="{{ form.title.name }}" id="{{ form.title.id_for_label }}"
          value="{{ form.title.value|default:'' }}"
          class="w-full px-4 py-3 bg-[#241D44] border-2 border-[#4F46E5] rounded-lg text-[#f0f1f4] focus:ring-2 focus:ring-[#622bbf] focus:outline-none transition-all"
          placeholder="Escribe un título">
        {% if form.title.errors %}
        <ul class="mt-1 text-sm text-[#EF4444]">
          {% for error in form.title.errors %}
          <li>{{ error }}</li>
          {% endfor %}
        </ul>
        {% endif %}
      </div>

      <!-- Descripción -->
      <div class="form-group">
        <label class="block mb-2 text-[#f0f1f4] font-medium">Descripción</label>
        <textarea name="{{ form.content.name }}" id="{{ form.content.id_for_label }}"
          class="w-full px-4 py-3 bg-[#241D44] border-2 border-[#4F46E5] rounded-lg text-[#f0f1f4] focus:ring-2 focus:ring-[#622bbf] focus:outline-none transition-all"
          rows="6" placeholder="Escribe una descripción...">{{ form.content.value|default:'' }}</textarea>
        {% if form.content.errors %}
        <ul class="mt-1 text-sm text-[#EF4444]">
          {% for error in form.content.errors %}
          <li>{{ error }}</li>
          {% endfor %}
        </ul>
        {% endif %}
      </div>

      <!-- Categoría -->
      <div class="form-group">
        <label class="block mb-2 text-[#f0f1f4] font-medium">Categoría</label>
        <select name="{{ form.category.name }}" id="{{ form.category.id_for_label }}"
          class="w-full px-4 py-3 bg-[#241D44] border-2 border-[#4F46E5] rounded-lg text-[#f0f1f4] focus:ring-2 focus:ring-[#622bbf] focus:outline-none transition-all">
          <option value="">Selecciona una categoría</option>
          {% for choice in form.category.field.choices %}
          <option value="{{ choice.0 }}">{{ choice.1 }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Formset de imágenes -->
      <div class="mt-8">
        <h3 class="text-xl font-semibold mb-4 text-[#f0f1f4]">Imágenes</h3>
        <div class="space-y-4" id="images-formset">
          {{ form.images.management_form }}
          {% for image_form in form.images %}
          <div class="bg-[#130C2A] p-4 rounded-lg border border-[#241D44] image-form">
            {% for hidden in image_form.hidden_fields %}
            {{ hidden }}
            {% endfor %}

            <label class="block text-[#f0f1f4] mb-2">Imagen {{ forloop.counter }}</label>
            <input type="file" name="{{ image_form.image.html_name }}" id="{{ image_form.image.id_for_label }}"
              class="w-full px-3 py-2 bg-[#241D44] border border-[#4F46E5] rounded text-[#f0f1f4] file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-[#622bbf] file:text-white hover:file:bg-[#4F46E5]"
              {% if not image_form.instance.pk %}required{% endif %}>
          </div>
          {% endfor %}
        </div>
        <button type="button" id="add-image-btn"
          class="mt-3 px-4 py-2 bg-[#241D44] hover:bg-[#4F46E5] text-[#f0f1f4] rounded-lg transition-colors">
          + Añadir otra imagen
        </button>
      </div>

      <!-- Botón de enviar -->
      <button type="submit"
        class="w-full py-3 px-6 bg-[#622bbf] hover:bg-[#4F46E5] text-white font-bold rounded-lg transition-colors duration-300 mt-6 shadow-lg hover:shadow-[#4F46E5]/50">
        Publicar Post
      </button>
  </form>
</div>

{% endblock content_layout %}

{% block scripts %}
<!-- Script para añadir imágenes dinámicamente -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const addButton = document.getElementById('add-image-btn');
    const formsetContainer = document.getElementById('images-formset');
    const totalForms = document.getElementById('id_images-TOTAL_FORMS');
    let formCount = parseInt(totalForms.value);

    addButton.addEventListener('click', function () {
      const newForm = document.querySelector('.image-form').cloneNode(true);
      const newFormHtml = newForm.innerHTML.replace(/images-\d+-/g, `images-${formCount}-`);

      // Crear un nuevo div con el formulario
      const newDiv = document.createElement('div');
      newDiv.className = 'bg-[#130C2A] p-4 rounded-lg border border-[#241D44] image-form';
      newDiv.innerHTML = newFormHtml;

      // Actualizar el label
      const label = newDiv.querySelector('label');
      if (label) {
        label.textContent = `Imagen ${formCount + 1}`;
      }

      // Limpiar el valor del input file
      const fileInput = newDiv.querySelector('input[type="file"]');
      if (fileInput) {
        fileInput.value = '';
      }

      formsetContainer.appendChild(newDiv);
      formCount++;
      totalForms.value = formCount;
    });
  });
</script>
{% endblock scripts %}