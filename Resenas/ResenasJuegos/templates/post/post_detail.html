{% extends 'layouts/general_layout.html' %}


{% block content_layout %}
<article class="max-w-3xl mx-auto p-6 bg-white shadow rounded">
  <!-- TITULO Y FECHA -->
  <h1 class="text-3xl font-bold mb-4">{{ post.title }}</h1>
  <p class="text-gray-500 text-sm mb-6">Publicado el {{ post.created_at|date:"d M Y" }}</p>
  
{% if user.is_authenticated %}
    <form method="post" action="{% url 'toggle_favorite' post.slug %}">
        {% csrf_token %}
        {% if is_favorited %}
            <button type="submit" class="bg-red-500 text-white px-3 py-1 rounded">
                Quitar de favoritos
            </button>
        {% else %}
            <button type="submit" class="bg-green-500 text-white px-3 py-1 rounded">
                Agregar a favoritos
            </button>
        {% endif %}
    </form>
{% endif %}

  {% if post.images.all %}
  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
    {% for imagen in post.images.all %}
    <img src="{{ imagen.image.url }}" alt="{{ post.title }}" class="w-full rounded">
    {% endfor %}
  </div>
  {% endif %}

  <div class="text-lg leading-relaxed mb-6">
    {{ post.content|linebreaks }}
  </div>

  <div class="flex gap-4 text-sm text-gray-600 mb-6">
    <div>
      <strong>Categorías:</strong>
      {% for cat in post.category.all %}
      <span class="inline-block bg-gray-200 px-2 py-1 rounded">{{ cat.title }}</span>
      {% endfor %}
    </div>
    <div>
      <strong>Plataformas:</strong>
      {% for plat in post.plataform.all %}
      <span class="inline-block bg-gray-200 px-2 py-1 rounded">{{ plat.title }}</span>
      {% endfor %}
    </div>
  </div>

  <hr class="my-6">
  <h2 class="text-2xl font-semibold mb-4">Reseñas</h2>

  {% for comment in comments %}
  <div class="mb-4 p-4 bg-gray-100 rounded shadow">
    <div class="flex justify-between items-center">
      <span class="font-bold">{{ comment.user.username }}</span>
      <span class="text-yellow-500">{{ comment.score }} ⭐</span>
    </div>
    <p class="mt-2 text-gray-800">{{ comment.content }}</p>

    {% if request.user == comment.user %}
    <div class="flex gap-2 mt-2">
      <!-- Botón Editar -->
      <a href="?edit_comment_id={{ comment.id }}" class="text-indigo-600 hover:underline text-sm">
        Editar
      </a>

      <!-- Botón Eliminar -->
      <form method="post" style="display:inline;">
        {% csrf_token %}
        <input type="hidden" name="delete_comment_id" value="{{ comment.id }}">
        <button type="submit" class="text-red-600 hover:underline text-sm">
          Eliminar
        </button>
      </form>
    </div>
    {% endif %}
  </div>
  {% empty %}
  <p class="text-gray-500">No hay reseñas aún.</p>
  {% endfor %}

  {% if user.is_authenticated %}
  <hr class="my-6">
  {% if editing %}
  <h3 class="text-xl font-semibold mb-2">Editando tu reseña</h3>
  <form method="post">
    {% csrf_token %}
    <input type="hidden" name="comment_id" value="{{ editing.id }}">
    {{ form.as_p }}
    <div class="flex gap-2 mt-2">
      <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded">Guardar cambios</button>
      <a href="{% url 'post_detail' post.slug %}" class="px-4 py-2 bg-gray-300 rounded">Cancelar</a>
    </div>
  </form>
  {% else %}
  <h3 class="text-xl font-semibold mb-2">Dejá tu reseña</h3>
  <form method="post">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit" class="mt-2 bg-indigo-600 text-white px-4 py-2 rounded">Enviar</button>
  </form>
  {% endif %}
  {% else %}
  <p class="text-gray-500 mt-6">Iniciá sesión para dejar tu comentario y puntuación.</p>
  {% endif %}

  <a href="{% url 'home' %}" class="inline-block mt-8 text-indigo-600 hover:underline">← Volver al inicio</a>
</article>
{% endblock %}

#TODO: AGREGAR CONFIRMACIÓN DE: ¿Desea eliminar este comentario?








<!-- ######################################ORIGINAL-ORIGINAL################################################## -->

<!-- #TODO: REVISAR LOS ROLES Y PERMISOS
#TODO:REVISAR URLS -->

{% block content_layout %}
<div class="max-w-6xl mx-auto px-4 py-8">
  <!-- Sección principal con imagen y botones -->
  <div class="relative mb-8 rounded-xl overflow-hidden bg-[#130C2A] border border-[#241D44]">
    {% if post.images.all %}
    <a href="{% url 'post_detail' post.id %}">
      <img src="{{ post.images.first.image.url }}" alt="{{ post.title }}"
        class="w-full h-[400px] object-cover opacity-90">
    </a>
    {% endif %}

    <div class="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-[#0B071A] to-transparent">
      <div class="flex justify-between items-end">
        <div>
          <h1 class="text-4xl font-bold text-[#f0f1f4] mb-2">{{ post.title }}</h1>
        </div>
        <div class="flex gap-3">
          <a href="{% url 'post_update' post.slug %}"
            class="bg-[#4F46E5] hover:bg-[#4338CA] text-white font-bold py-3 px-6 rounded-lg transition-colors duration-300 shadow-lg hover:shadow-[#4F46E5]/50">
            Editar
          </a>
          <button type="button" onclick="openDeleteModal()"
            class="bg-[#EF4444] hover:bg-[#DC2626] text-white font-bold py-3 px-6 rounded-lg transition-colors duration-300 shadow-lg hover:shadow-[#EF4444]/50">
            Eliminar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Sección de información del juego -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">
    <!-- Contenido principal -->
    <div class="md:col-span-2 space-y-6">
      <div class="bg-[#0B071A] p-6 rounded-xl border border-[#241D44]">
        <h2 class="text-2xl font-bold mb-4 text-[#f0f1f4]">Descripción</h2>
        <div class="text-[#f0f1f4] leading-relaxed">
          {{ post.content|linebreaks }}
        </div>
      </div>

      <!-- Categorías -->
      <div class="bg-[#0B071A] p-6 rounded-xl border border-[#241D44]">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <h3 class="text-xl font-semibold mb-3 text-[#f0f1f4]">Categorías</h3>
            <div class="flex flex-wrap gap-2">
              {% for cat in post.category.all %}
              <span class="bg-[#241D44] text-[#f0f1f4] px-3 py-1 rounded-full text-sm">{{ cat.title }}</span>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Informacion -->
    <div class="space-y-6">
      <div class="bg-[#0B071A] p-6 rounded-xl border border-[#241D44]">
        <h2 class="text-2xl font-bold mb-4 text-[#f0f1f4]">Información</h2>
        <div class="space-y-3 text-[#f0f1f4]">
          <div>
            <span class="font-semibold">Calificación:</span>
            <span>{{ post.rating|default:"-" }}/10 ({{ post.votes|default:"0" }} votos)</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sección de reseñas -->
  <div class="bg-[#0B071A] p-6 rounded-xl border border-[#241D44] mb-8">
    <h2 class="text-2xl font-bold mb-6 text-[#f0f1f4]">Comentarios</h2>

    {% for comment in comments %}
    <div class="mb-4 p-4 bg-[#130C2A] rounded-lg border border-[#241D44]">
      <div class="flex justify-between items-center mb-2">
        <span class="font-bold text-[#f0f1f4]">{{ comment.user.username }}</span>
        <span class="text-yellow-500">{{ comment.score }} ⭐</span>
      </div>
      <p class="text-[#f0f1f4]">{{ comment.content }}</p>
    </div>
    {% empty %}
    <p class="text-[#f0f1f4] opacity-80 pb-6 border-b border-[#241D44]">No hay comentarios aún.</p>
    {% endfor %}


    {% if user.is_authenticated %}
    <h3 class="text-xl font-semibold mb-4 mt-6 text-[#f0f1f4]">Dejá tu reseña</h3>
    <form method="post">
      {% csrf_token %}
      <div class="space-y-4">
        <!-- Campo de contenido -->
        <div class="form-group">
          <textarea name="content"
            class="w-full bg-[#130C2A] text-[#f0f1f4] p-4 rounded-lg border border-[#241D44] focus:outline-none focus:ring-2 focus:ring-[#4F46E5] focus:border-transparent"
            rows="4" placeholder="Escribí tu reseña acá..."></textarea>
        </div>

        <!-- Sistema de puntuación por estrellas  -->
        <div class="form-group">
          <label class="block mb-2 text-[#f0f1f4] font-medium">Puntuación</label>
          <div class="flex items-center space-x-1 star-rating">
            {% for i in "12345"|make_list %}
            <label class="cursor-pointer">
              <input type="radio" name="score" value="{{ i }}" class="hidden peer star-{{ i }}">
              <span
                class="text-3xl {% if forloop.counter <= 3 %}text-yellow-500{% else %}text-gray-400{% endif %} hover:text-yellow-500 transition-colors duration-200">★</span>
            </label>
            {% endfor %}
          </div>
        </div>
      </div>
      <button type="submit"
        class="mt-4 bg-[#4F46E5] hover:bg-[#4338CA] text-white px-4 py-2 rounded-lg transition-colors">
        Enviar
      </button>
    </form>
    {% else %}
    <p class="text-[#f0f1f4] opacity-80 mt-6">Iniciá sesión para dejar tu comentario y puntuación.</p>
    {% endif %}
  </div>

  <!-- Modal de Confirmación de Eliminación -->
  <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 p-4 hidden">
    <div class="flex items-center justify-center h-full">
      <div class="bg-[#0B071A] border border-[#241D44] rounded-xl p-6 max-w-md w-full">
        <div class="text-center mb-4">
          <h2 class="text-2xl font-bold text-[#f0f1f4]">Eliminar Post: {{ post.title }}</h2>
        </div>

        <div class="flex items-start mb-6">
          <div class="p-2 bg-[#241D44] rounded-lg mr-4">
            {% include 'partials/home_icons/warning_icon.html' %}
          </div>
          <div>
            <p class="text-[#A7A1B8]">
              Esta acción eliminará permanentemente el post y todos sus datos asociados.
              ¿Estás completamente seguro de continuar?
            </p>
          </div>
        </div>

        <div class="flex flex-col sm:flex-row justify-center gap-4">
          <form method="post" action="{% url 'post_delete' post.id %}" class="m-0 flex-1">
            {% csrf_token %}
            <button type="submit"
              class="w-full px-6 py-3 bg-[#EF4444] hover:bg-[#DC2626] text-white font-bold rounded-lg transition-colors duration-300 shadow-lg hover:shadow-[#EF4444]/50 flex items-center justify-center gap-2">
              <span class="w-6 h-6">{% include 'partials/home_icons/delete_icon.html' %}</span>
              Sí, eliminar definitivamente
            </button>
          </form>
          <button onclick="closeDeleteModal()"
            class="flex-1 px-6 py-3 bg-[#241D44] hover:bg-[#4F46E5] text-[#f0f1f4] font-bold rounded-lg transition-colors duration-300">
            Cancelar y volver
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock content_layout %}

{% block scripts %}
<script>
  // Sistema de estrellas mejorado
  document.querySelectorAll('.star-rating input[type="radio"]').forEach(radio => {
    // Al hacer clic
    radio.addEventListener('change', function () {
      const selectedValue = parseInt(this.value);
      const stars = document.querySelectorAll('.star-rating span');

      stars.forEach((star, index) => {
        if (index < selectedValue) {
          star.classList.remove('text-gray-400');
          star.classList.add('text-yellow-500');
        } else {
          star.classList.remove('text-yellow-500');
          star.classList.add('text-gray-400');
        }
      });
    });

    // Efecto hover
    radio.addEventListener('mouseover', function () {
      const hoverValue = parseInt(this.value);
      const stars = document.querySelectorAll('.star-rating span');

      stars.forEach((star, index) => {
        if (index < hoverValue) {
          star.classList.add('text-yellow-500');
        }
      });
    });

    radio.addEventListener('mouseout', function () {
      const selectedRadio = document.querySelector('.star-rating input[type="radio"]:checked');
      const stars = document.querySelectorAll('.star-rating span');

      if (!selectedRadio) {
        stars.forEach((star, index) => {
          star.classList.remove('text-yellow-500');
          star.classList.add('text-gray-400');
        });
        return;
      }

      const selectedValue = parseInt(selectedRadio.value);
      stars.forEach((star, index) => {
        if (index < selectedValue) {
          star.classList.add('text-yellow-500');
        } else {
          star.classList.remove('text-yellow-500');
          star.classList.add('text-gray-400');
        }
      });
    });
  });

  // Funciones para manejar el modal
  function openDeleteModal() {
    document.getElementById('deleteModal').classList.remove('hidden');
    document.body.classList.add('overflow-hidden'); // Bloquear scroll
  }

  function closeDeleteModal() {
    document.getElementById('deleteModal').classList.add('hidden');
    document.body.classList.remove('overflow-hidden'); // Restaurar scroll
  }

  // Cerrar modal al hacer clic fuera del contenido
  document.getElementById('deleteModal').addEventListener('click', function (e) {
    if (e.target === this) {
      closeDeleteModal();
    }
  });
</script>
{% endblock scripts %}